<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏£‡πå Flex Message + Templates</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- FlexHTML Library (Assumed local or CDN) -->
  <script src="flexhtml.js"></script>
  <link rel="stylesheet" href="flexhtml.css">

  <style>
    :root {
      --primary-color: #06c755;
      --bg-color: #f8f9fa;
    }

    body {
      background-color: var(--bg-color);
      font-family: 'Kanit', sans-serif;
      overflow-x: hidden;
    }

    .hide { display: none !important; }

    /* Loader */
    #loader-sec {
      position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
      background: white; z-index: 9999;
      display: flex; justify-content: center; align-items: center; flex-direction: column;
    }

    .spinner-custom {
      width: 3rem; height: 3rem;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Login Section */
    #login-sec { height: 100vh; display: flex; justify-content: center; align-items: center; }
    .btn-line { background-color: #06c755; color: white; font-weight: 600; }
    .btn-line:hover { background-color: #05b34c; color: white; }

    /* Main App */
    .preview-box {
      background-color: #849ebf;
      background-image: url('https://cdn.pixabay.com/photo/2016/06/02/02/33/triangles-1430105_1280.png'); 
      background-size: cover;
      min-height: 400px; max-height: 600px; overflow-y: auto;
      border-radius: 10px; padding: 15px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
    }
     
    .reset-this { all: initial; font-family: 'Kanit', sans-serif; }
    .reset-this * { box-sizing: border-box; }

    .flex-card {
      transition: transform 0.2s;
      border-left: 5px solid var(--primary-color);
      position: relative;
    }
     
    .flex-card:hover { transform: translateY(-2px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; }
    .high-z-index { z-index: 1050 !important; position: relative; transform: none !important; }

    .avatar-img { width: 50px; height: 50px; object-fit: cover; border: 2px solid var(--primary-color); }

    /* Pagination Styles */
    .pagination .page-link {
        border: none; color: #6c757d; margin: 0 3px;
        border-radius: 50% !important; width: 36px; height: 36px;
        display: flex; align-items: center; justify-content: center;
        font-weight: 500; transition: all 0.2s;
    }
    .pagination .page-link:hover { background-color: #e9ecef; color: var(--primary-color); transform: translateY(-2px); }
    .pagination .page-item.active .page-link { background-color: var(--primary-color); color: white; box-shadow: 0 2px 5px rgba(6, 199, 85, 0.4); }
    .pagination .page-item.disabled .page-link { opacity: 0.5; background-color: transparent; }

    /* Template Modal Styles */
    .template-card {
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
    }
    .template-card:hover {
        border-color: var(--primary-color);
        background-color: #f0fff4;
        transform: translateY(-3px);
    }
    .template-icon { font-size: 2.5rem; }
  </style>
</head>

<body>

  <!-- Loader -->
  <section id="loader-sec">
    <div class="spinner-custom mb-3"></div>
    <div class="fw-bold text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </section>

  <!-- Login -->
  <section id="login-sec" class="hide">
    <div class="text-center p-5 bg-white rounded shadow-sm">
      <h3 class="fw-bold mb-4">Flex Message Creator</h3>
      <p class="text-muted mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
      <button class="btn btn-lg btn-line w-100" id="login-btn">
        <i class="bi bi-line me-2"></i> Log in with LINE
      </button>
    </div>
  </section>

  <!-- Main Input Section -->
  <section id="input-sec" class="container py-4 hide">
     
    <div class="d-flex align-items-center justify-content-between mb-4">
      <div>
        <h4 class="fw-bold mb-0">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="displayName" class="text-primary">User</span></h4>
        <small class="text-muted">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏£‡πå Flex Message ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÄ‡∏ó‡∏®‡∏Å‡∏≤‡∏•</small>
      </div>
      <img id="display-img" class="rounded-circle avatar-img shadow-sm" src="" alt="Profile">
    </div>

    <div class="row g-4">
      <!-- Left Column: Editor -->
      <div class="col-lg-7">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body">
             
            <div class="mb-3">
              <label for="altText" class="form-label fw-bold">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏ó (Alt Text)</label>
              <div class="input-group">
                <input type="text" class="form-control" id="altText" maxlength="400" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏ß‡∏±‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà!">
                <span class="input-group-text bg-light" id="text-count">0/400</span>
              </div>
            </div>

            <div class="mb-2 d-flex justify-content-between align-items-center flex-wrap gap-2">
              <label for="json" class="form-label fw-bold mb-0">Flex JSON Code</label>
              <div>
                  <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#templateModal">
                    <i class="bi bi-magic"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÄ‡∏ó‡∏®‡∏Å‡∏≤‡∏•
                  </button>
                  <a href="https://developers.line.biz/flex-simulator/" target="_blank" class="btn btn-sm btn-outline-info">
                    <i class="bi bi-tools"></i> Simulator
                  </a>
              </div>
            </div>
             
            <textarea id="json" class="form-control font-monospace mb-3" rows="12" style="font-size: 0.85rem;" placeholder='‡∏ß‡∏≤‡∏á JSON code ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï...'></textarea>

            <div class="row g-2">
              <div class="col-6">
                <button id="save-btn" class="btn btn-primary w-100"><i class="bi bi-save me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              </div>
              <div class="col-6">
                <button id="share-btn" class="btn btn-success w-100"><i class="bi bi-share-fill me-1"></i> ‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏•‡∏¢</button>
              </div>
              <div class="col-12 mt-2">
                 <button id="send-chat-btn" class="btn btn-warning w-100 text-dark hide"><i class="bi bi-send-fill me-1"></i> ‡∏™‡πà‡∏á‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏ô‡∏µ‡πâ</button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Right Column: Preview -->
      <div class="col-lg-5">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-header bg-white fw-bold d-flex justify-content-between">
            <span><i class="bi bi-eye"></i> Live Preview</span>
            <small class="text-muted" style="font-size: 0.7rem;">*‡∏£‡∏π‡∏õ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏ö‡∏≤‡∏á‡πÄ‡∏ô‡πá‡∏ï‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏Ñ</small>
          </div>
          <div class="preview-box">
             <div class="reset-this">
                <div id="flex-show" style="width: 100%; padding: 10px;">
                    <div class="text-white text-center mt-5 opacity-50">
                    <i class="bi bi-chat-square-dots display-1"></i>
                    <p class="mt-2">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                    </div>
                </div>
             </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Saved List Section -->
    <div class="mt-5">
      <div class="d-flex justify-content-between align-items-end mb-3">
        <h5 class="fw-bold mb-0 border-start border-4 border-primary ps-2"> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h5>
      </div>

      <div class="row mb-4">
        <div class="col-12">
          <div class="input-group shadow-sm">
            <span class="input-group-text bg-white border-end-0 text-muted">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" id="search-input" class="form-control border-start-0 ps-0" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ Template..." autocomplete="off">
            <button class="btn btn-white border border-start-0" type="button" id="clear-search-btn" style="display: none;">
              <i class="bi bi-x-circle-fill text-secondary"></i>
            </button>
          </div>
        </div>
      </div>

      <div id="flexlist" class="row g-3">
        <div class="col-md-6 col-lg-4 template-item hide">
          <div class="card flex-card shadow-sm h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div class="text-truncate me-2 w-100 fw-bold item-name">Template Name</div>
              <div class="dropdown">
                <button class="btn btn-light btn-sm rounded-circle" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                  <li><a class="dropdown-item load-item" href="#"><i class="bi bi-pencil-square me-2 text-primary"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡πÇ‡∏´‡∏•‡∏î</a></li>
                  <li><a class="dropdown-item share-item" href="#"><i class="bi bi-share me-2 text-success"></i>‡πÅ‡∏ä‡∏£‡πå</a></li>
                  <li><a class="dropdown-item copy-link" href="#"><i class="bi bi-link-45deg me-2 text-warning"></i>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item delete-item text-danger" href="#"><i class="bi bi-trash me-2"></i>‡∏•‡∏ö</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
       
      <div id="empty-list" class="text-center text-muted py-5 hide">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>

      <div class="row mt-4">
        <div class="col-12 d-flex justify-content-center">
           <nav aria-label="Page navigation">
             <ul class="pagination shadow-sm" id="pagination-controls"></ul>
           </nav>
        </div>
        <div class="col-12 text-center text-muted small mt-2">
           ‡πÅ‡∏™‡∏î‡∏á <span id="page-info-start">0</span> - <span id="page-info-end">0</span> ‡∏à‡∏≤‡∏Å <span id="page-info-total">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        </div>
      </div>

    </div>

  </section>

  <!-- Template Modal -->
  <div class="modal fade" id="templateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold"><i class="bi bi-calendar-event me-2"></i>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏ï‡∏≤‡∏°‡πÄ‡∏ó‡∏®‡∏Å‡∏≤‡∏•</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body bg-light">
           <div class="row g-3" id="template-container">
               <!-- Templates will be injected here -->
           </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
  <script>
    // --- Config ---
    const LIFF_ID = '2005615503-Ar8OBd2N'; 
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwDd1Nnw729Y01YuWrHVkgDU_8aKmWq15onm7sncp_IfU5SAwJmL3ccofV_UtQX5qMT/exec';

    // --- Template Data (Festivals) ---
    const TEMPLATES = [
        {
            id: 'newyear',
            name: '‡∏ß‡∏±‡∏ô‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà (New Year)',
            icon: 'üéâ',
            alt: '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà 2568',
            json: {
              "type": "bubble",
              "hero": { "type": "image", "url": "https://images.unsplash.com/photo-1546272983-581292025703?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80", "size": "full", "aspectRatio": "20:13", "aspectMode": "cover", "action": { "type": "uri", "uri": "http://linecorp.com/" } },
              "body": { "type": "box", "layout": "vertical", "contents": [ { "type": "text", "text": "Happy New Year!", "weight": "bold", "size": "xl", "color": "#E6AC00" }, { "type": "text", "text": "‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡πÜ ‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏≠‡∏¢‡∏¢‡∏¥‡πâ‡∏°", "wrap": true, "size": "sm", "color": "#666666", "margin": "md" } ] },
              "footer": { "type": "box", "layout": "vertical", "spacing": "sm", "contents": [ { "type": "button", "style": "primary", "height": "sm", "action": { "type": "uri", "label": "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏≠‡∏ß‡∏¢‡∏û‡∏£", "uri": "https://line.me" }, "color": "#E6AC00" } ], "flex": 0 }
            }
        },
        {
            id: 'valentine',
            name: '‡∏ß‡∏±‡∏ô‡∏ß‡∏≤‡πÄ‡∏•‡∏ô‡πÑ‡∏ó‡∏ô‡πå',
            icon: 'üíñ',
            alt: 'Happy Valentine Day',
            json: {
              "type": "bubble",
              "styles": { "footer": { "separator": true } },
              "hero": { "type": "image", "url": "https://images.unsplash.com/photo-1518199266791-5375a83190b7?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80", "size": "full", "aspectRatio": "20:13", "aspectMode": "cover" },
              "body": { "type": "box", "layout": "vertical", "contents": [ { "type": "text", "text": "Happy Valentine's Day", "weight": "bold", "size": "xl", "color": "#ff4081" }, { "type": "text", "text": "‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©\n‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏Ñ‡∏π‡πà‡∏£‡∏±‡∏Å ‡∏•‡∏î 50%", "wrap": true, "color": "#666666", "margin": "md" } ] },
              "footer": { "type": "box", "layout": "vertical", "contents": [ { "type": "button", "action": { "type": "uri", "label": "‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", "uri": "https://line.me" }, "color": "#ff4081", "style": "primary" } ] }
            }
        },
        {
            id: 'songkran',
            name: '‡∏ß‡∏±‡∏ô‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå',
            icon: 'üî´',
            alt: '‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏ß‡∏±‡∏ô‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå',
            json: {
              "type": "bubble",
              "hero": { "type": "image", "url": "https://images.unsplash.com/photo-1555400038-63f5ba517a47?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80", "size": "full", "aspectRatio": "20:13", "aspectMode": "cover" },
              "body": { "type": "box", "layout": "vertical", "contents": [ { "type": "text", "text": "‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏ß‡∏±‡∏ô‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå", "weight": "bold", "size": "xl", "color": "#1DB446" }, { "type": "separator", "margin": "md" }, { "type": "text", "text": "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏î‡∏≥‡∏´‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏ï‡∏•‡∏≠‡∏î‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏ó‡∏¢‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö", "wrap": true, "margin": "md", "color": "#555555" } ] }
            }
        },
        {
            id: 'halloween',
            name: '‡∏ß‡∏±‡∏ô‡∏Æ‡∏≤‡πÇ‡∏•‡∏ß‡∏µ‡∏ô',
            icon: 'üéÉ',
            alt: 'Trick or Treat!',
            json: {
              "type": "bubble",
              "body": { "type": "box", "layout": "vertical", "contents": [ { "type": "image", "url": "https://images.unsplash.com/photo-1508361001413-7a9dca21d08a?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80", "size": "full", "aspectMode": "cover", "aspectRatio": "1:1", "gravity": "center" }, { "type": "box", "layout": "vertical", "contents": [ { "type": "text", "text": "Halloween Sale", "size": "xl", "color": "#ffffff", "weight": "bold" }, { "type": "text", "text": "‡∏•‡∏î‡∏Å‡∏£‡∏∞‡∏´‡∏ô‡πà‡∏≥‡∏£‡∏±‡∏ö‡∏ú‡∏µ‡∏´‡∏•‡∏≠‡∏Å üëª", "color": "#eeeeee", "size": "sm" } ], "position": "absolute", "offsetBottom": "0px", "offsetStart": "0px", "offsetEnd": "0px", "backgroundColor": "#000000aa", "paddingAll": "20px" } ], "paddingAll": "0px" },
              "footer": { "type": "box", "layout": "vertical", "contents": [ { "type": "button", "action": { "type": "uri", "label": "‡∏ä‡πâ‡∏≠‡∏õ‡πÄ‡∏•‡∏¢", "uri": "https://line.me" }, "style": "primary", "color": "#ff6d00" } ], "backgroundColor": "#2b2b2b" }
            }
        },
        {
            id: 'christmas',
            name: '‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå‡∏°‡∏≤‡∏™',
            icon: 'üéÑ',
            alt: 'Merry Christmas',
            json: {
              "type": "bubble",
              "hero": { "type": "image", "url": "https://images.unsplash.com/photo-1512389142860-9c449e58a543?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80", "size": "full", "aspectRatio": "20:13", "aspectMode": "cover" },
              "body": { "type": "box", "layout": "vertical", "contents": [ { "type": "text", "text": "Merry Christmas", "weight": "bold", "size": "xl", "color": "#d32f2f" }, { "type": "text", "text": "‡∏Ç‡∏≠‡∏ã‡∏≤‡∏ô‡∏ï‡πâ‡∏≤‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß", "wrap": true, "margin": "md", "color": "#2e7d32" } ] }
            }
        },
        {
            id: 'motherday',
            name: '‡∏ß‡∏±‡∏ô‡πÅ‡∏°‡πà‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥',
            icon: 'üíô',
            alt: '‡∏£‡∏±‡∏Å‡πÅ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î',
            json: {
              "type": "bubble",
              "hero": { "type": "image", "url": "https://images.unsplash.com/photo-1564595822394-263595ae1586?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80", "size": "full", "aspectRatio": "20:13", "aspectMode": "cover" },
              "body": { "type": "box", "layout": "vertical", "contents": [ { "type": "text", "text": "Happy Mother's Day", "weight": "bold", "size": "xl", "color": "#1976D2" }, { "type": "text", "text": "‡∏ö‡∏≠‡∏Å‡∏£‡∏±‡∏Å‡πÅ‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏™‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©\n‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÜ", "wrap": true, "margin": "md", "color": "#555555" } ] },
              "footer": { "type": "box", "layout": "vertical", "contents": [ { "type": "button", "action": { "type": "uri", "label": "‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î", "uri": "https://line.me" }, "style": "primary", "color": "#42A5F5" } ] }
            }
        },
         {
            id: 'marketing',
            name: '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
            icon: 'üõçÔ∏è',
            alt: '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©',
            json: {
              "type": "bubble",
              "hero": { "type": "image", "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_1_cafe.png", "size": "full", "aspectRatio": "20:13", "aspectMode": "cover" },
              "body": { "type": "box", "layout": "vertical", "contents": [ { "type": "text", "text": "Flash Sale!", "weight": "bold", "size": "xl" }, { "type": "box", "layout": "baseline", "margin": "md", "contents": [ { "type": "icon", "size": "sm", "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/review_gold_star_28.png" }, { "type": "icon", "size": "sm", "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/review_gold_star_28.png" }, { "type": "icon", "size": "sm", "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/review_gold_star_28.png" }, { "type": "icon", "size": "sm", "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/review_gold_star_28.png" }, { "type": "icon", "size": "sm", "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/review_gray_star_28.png" }, { "type": "text", "text": "4.0", "size": "sm", "color": "#999999", "margin": "md", "flex": 0 } ] }, { "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm", "contents": [ { "type": "box", "layout": "baseline", "spacing": "sm", "contents": [ { "type": "text", "text": "Place", "color": "#aaaaaa", "size": "sm", "flex": 1 }, { "type": "text", "text": "Miraina Tower, 4-1-6 Shinjuku, Tokyo", "wrap": true, "color": "#666666", "size": "sm", "flex": 5 } ] }, { "type": "box", "layout": "baseline", "spacing": "sm", "contents": [ { "type": "text", "text": "Time", "color": "#aaaaaa", "size": "sm", "flex": 1 }, { "type": "text", "text": "10:00 - 23:00", "wrap": true, "color": "#666666", "size": "sm", "flex": 5 } ] } ] } ], },
              "footer": { "type": "box", "layout": "vertical", "spacing": "sm", "contents": [ { "type": "button", "style": "link", "height": "sm", "action": { "type": "uri", "label": "CALL", "uri": "https://linecorp.com" } }, { "type": "button", "style": "link", "height": "sm", "action": { "type": "uri", "label": "WEBSITE", "uri": "https://linecorp.com" } }, { "type": "spacer", "size": "sm" } ], "flex": 0 }
            }
        }
    ];

    // --- State & Pagination ---
    let userProfile = null;
    let currentFlexId = null;
    let itemTemplate = null;
    const ITEMS_PER_PAGE = 6; 
    let currentPage = 1;

    // --- Utils ---
    const toast = Swal.mixin({
      toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true
    });

    // --- Main Logic ---
    $(document).ready(function() {
        main();
        itemTemplate = $('.template-item').first().clone();
        
        $('#json').on('input', function() { renderPreview(); });
        $('#altText').on('input', function() { $('#text-count').text(`${this.value.length}/400`); });
        $('#login-btn').click(() => liff.login({ redirectUri: window.location.href }));
        $('#save-btn').click(saveFlex);
        $('#share-btn').click(() => {
            const jsonStr = $('#json').val();
            const altText = $('#altText').val();
            if(isValidJson(jsonStr)) shareFlex(JSON.parse(jsonStr), altText);
            else Swal.fire('Error', 'JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        });
        $('#send-chat-btn').click(sendInChat);

        // --- Init Templates ---
        renderTemplateList();

        // --- Search Logic ---
        $('#search-input').on('keyup', function() {
            let value = $(this).val().toLowerCase();
            
            if (value.length > 0) $('#clear-search-btn').show();
            else $('#clear-search-btn').hide();

            let totalFound = 0;
            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà class filtered-match ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á
            $('#flexlist > div:not(.template-item)').each(function() {
                let text = $(this).find('.item-name').text().toLowerCase();
                if (text.indexOf(value) > -1) {
                    $(this).addClass('filtered-match');
                    totalFound++;
                } else {
                    $(this).removeClass('filtered-match');
                }
            });

            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏ö
            $('#no-search-result').remove();
            if (totalFound === 0 && value.length > 0) {
                 $('#flexlist').after(`
                    <div id="no-search-result" class="text-center text-muted py-4">
                        <i class="bi bi-search display-6 d-block mb-2 opacity-50"></i>
                        ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${value}"
                    </div>
                `);
            }

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î Pagination ‡πÉ‡∏´‡∏°‡πà
            currentPage = 1;
            renderPagination();
        });

        $('#clear-search-btn').click(function() {
            $('#search-input').val('').trigger('keyup').focus();
        });
    });

    // --- Template Functions ---
    function renderTemplateList() {
        const container = $('#template-container');
        container.empty();
        TEMPLATES.forEach(t => {
            const card = `
                <div class="col-6 col-md-4">
                    <div class="card h-100 template-card shadow-sm text-center p-3" onclick="applyTemplate('${t.id}')">
                        <div class="template-icon mb-2">${t.icon}</div>
                        <div class="fw-bold small text-dark">${t.name}</div>
                    </div>
                </div>
            `;
            container.append(card);
        });
    }

    function applyTemplate(id) {
        const template = TEMPLATES.find(t => t.id === id);
        if (template) {
            $('#json').val(JSON.stringify(template.json, null, 4));
            $('#altText').val(template.alt);
            $('#templateModal').modal('hide');
            renderPreview();
            toast.fire({ icon: 'success', title: `‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï: ${template.name}` });
        }
    }

    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
        
        if (!liff.isLoggedIn()) {
          $('#loader-sec').addClass('hide');
          $('#login-sec').removeClass('hide');
          return;
        }

        const params = new URLSearchParams(window.location.search);
        const sharedId = params.get('s');

        if (sharedId) {
          await handleSharedLink(sharedId);
          return;
        }

        await loadUserProfile();
        $('#loader-sec').addClass('hide');
        $('#input-sec').removeClass('hide');
        
        fetchSavedList();

      } catch (err) {
        console.error(err);
        Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î LIFF: ' + err.message, 'error');
      }
    }

    async function loadUserProfile() {
      const context = liff.getContext();
      if (context && context.type === 'square_chat') {
        userProfile = { displayName: 'OpenChat Member', userId: context.squareMemberId, pictureUrl: '', isSquare: true };
        $('#send-chat-btn').removeClass('hide');
      } else {
        userProfile = await liff.getProfile();
        if(liff.isInClient()) $('#send-chat-btn').removeClass('hide');
      }
      $('#displayName').text(userProfile.displayName);
      $('#display-img').attr('src', userProfile.pictureUrl || 'https://cdn-icons-png.flaticon.com/512/847/847969.png');
    }

    function callApi(action, data = {}) {
        return $.post(SCRIPT_URL, { q: action, uid: userProfile.userId, isSquare: userProfile.isSquare || false, ...data });
    }

    function fetchSavedList() {
      callApi('get').done(function(res) {
          $('#flexlist').empty(); 
          
          if (res.status === 200 && res.data.length > 0) {
            $('#empty-list').addClass('hide');
            res.data.forEach(item => renderListItem(item));
            
            // *** Initial Pagination Setup ***
            $('#flexlist > div:not(.template-item)').addClass('filtered-match');
            renderPagination();

          } else {
            $('#empty-list').removeClass('hide');
            // Clear pagination controls if empty
            $('#pagination-controls').empty();
            $('#page-info-total').text('0');
          }
      }).fail(() => Swal.fire('Error', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'));
    }

    function renderListItem(item) {
        if (!itemTemplate) return;
        let $clone = itemTemplate.clone();
        $clone.removeClass('hide template-item');
        $clone.find('.item-name').text(item.name);
        
        // Z-Index fix
        $clone.find('.dropdown').on('show.bs.dropdown', function () {
            $(this).closest('.col-md-6, .col-lg-4').addClass('high-z-index');
        }).on('hide.bs.dropdown', function () {
            $(this).closest('.col-md-6, .col-lg-4').removeClass('high-z-index');
        });

        $clone.find('.load-item').click(() => loadFlexToEditor(item));
        $clone.find('.share-item').click(() => shareFlex(JSON.parse(item.flex), item.name));
        $clone.find('.delete-item').click(function() { deleteFlex(item.flex_id, $clone); });
        $clone.find('.copy-link').click(() => {
            navigator.clipboard.writeText(`https://liff.line.me/${LIFF_ID}?s=${item.flex_id}`).then(() => toast.fire('success', '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß'));
        });

        $('#flexlist').append($clone);
    }

    // --- Pagination Logic ---
    function renderPagination() {
        let $items = $('#flexlist > div:not(.template-item).filtered-match');
        let totalItems = $items.length;
        let totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

        if (currentPage > totalPages) currentPage = totalPages || 1;
        if (currentPage < 1) currentPage = 1;

        let startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
        let endIndex = startIndex + ITEMS_PER_PAGE;

        $('#flexlist > div:not(.template-item)').addClass('hide');
        $items.slice(startIndex, endIndex).removeClass('hide');

        $('#page-info-start').text(totalItems === 0 ? 0 : startIndex + 1);
        $('#page-info-end').text(Math.min(endIndex, totalItems));
        $('#page-info-total').text(totalItems);

        createPaginationButtons(totalPages);
    }

    function createPaginationButtons(totalPages) {
        let $nav = $('#pagination-controls');
        $nav.empty();
        if (totalPages <= 1) return;

        let prevDisabled = currentPage === 1 ? 'disabled' : '';
        $nav.append(`<li class="page-item ${prevDisabled}"><a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;"><i class="bi bi-chevron-left"></i></a></li>`);

        for (let i = 1; i <= totalPages; i++) {
            let active = i === currentPage ? 'active' : '';
            $nav.append(`<li class="page-item ${active}"><a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a></li>`);
        }

        let nextDisabled = currentPage === totalPages ? 'disabled' : '';
        $nav.append(`<li class="page-item ${nextDisabled}"><a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;"><i class="bi bi-chevron-right"></i></a></li>`);
    }

    window.changePage = function(page) {
        currentPage = page;
        renderPagination();
        document.getElementById('flexlist').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // --- Actions ---
    function handleSharedLink(id) {
        $.post(SCRIPT_URL, { q: 'getflex', id: id }).done(function(res) {
            if (res.status === 200 && res.flex) {
                $('#loader-sec').addClass('hide');
                $('#json').val(JSON.stringify(JSON.parse(res.flex), null, 4));
                $('#altText').val(res.altText || 'Flex Message');
                renderPreview();
                Swal.fire({ title: '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ä‡∏£‡πå', text: `‡πÇ‡∏´‡∏•‡∏î Flex: ${res.altText} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, icon: 'success', confirmButtonText: '‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏•‡∏¢' })
                .then((result) => {
                    if(result.isConfirmed) shareFlex(JSON.parse(res.flex), res.altText);
                    else { $('#input-sec').removeClass('hide'); loadUserProfile(); }
                });
            } else {
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Flex', 'error').then(() => liff.closeWindow());
            }
        });
    }

    function loadFlexToEditor(item) {
        currentFlexId = item.flex_id;
        $('#altText').val(item.name);
        $('#json').val(JSON.stringify(JSON.parse(item.flex), null, 4));
        renderPreview();
        window.scrollTo({ top: 0, behavior: 'smooth' });
        $('#save-btn').html('<i class="bi bi-pencil-square me-1"></i> ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó').removeClass('btn-primary').addClass('btn-warning');
    }

    function saveFlex() {
        const jsonStr = $('#json').val();
        const altText = $('#altText').val() || 'Flex Message';
        if (!isValidJson(jsonStr)) return Swal.fire('Error', 'JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');

        Swal.showLoading();
        if (currentFlexId) {
             callApi('update', { id: currentFlexId, flex: jsonStr, name: altText }).done(function(res) {
                 Swal.close();
                 if(res.status === 200) {
                     toast.fire('success', '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                     fetchSavedList();
                     resetEditorState();
                 } else Swal.fire('Error', res.error, 'error');
             });
        } else {
            Swal.fire({ title: '‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ Flex', input: 'text', inputValue: altText, showCancelButton: true }).then((result) => {
                if (result.isConfirmed && result.value) {
                    Swal.showLoading();
                    callApi('put', { name: result.value, flex: jsonStr, liff_id: liff.id }).done(function(res) {
                        Swal.close();
                        if (res.result === 'success') {
                            toast.fire('success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                            fetchSavedList();
                        } else if (res.result === 'duplicate') Swal.fire('Warning', '‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥!', 'warning');
                        else Swal.fire('Error', res.message, 'error');
                    });
                }
            });
        }
    }

    function deleteFlex(id, $domElement) {
        Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢' }).then((result) => {
            if (result.isConfirmed) {
                Swal.showLoading();
                callApi('delete', { id: id }).done(function(res) {
                    Swal.close();
                    if (res.result === 200) {
                        $domElement.remove(); // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DOM
                        toast.fire('success', '‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                        if(currentFlexId === id) resetEditorState();
                        
                        // *** Re-calculate Pagination ***
                        renderPagination();
                    } else Swal.fire('Error', '‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                });
            }
        });
    }

    async function shareFlex(flexContent, altText) {
        const message = { type: 'flex', altText: altText || 'Sent a Flex Message', contents: flexContent };
        if (!liff.isApiAvailable('shareTargetPicker')) return Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå', 'error');
        try {
            const res = await liff.shareTargetPicker([message]);
            if (res) Swal.fire('Success', '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        } catch (err) { console.error(err); }
    }
    
    async function sendInChat() {
        const jsonStr = $('#json').val();
        if (!isValidJson(jsonStr)) return Swal.fire('Error', 'JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        try {
            await liff.sendMessages([{ type: 'flex', altText: $('#altText').val() || 'Flex', contents: JSON.parse(jsonStr) }]);
            Swal.fire('Success', '‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success').then(() => liff.closeWindow());
        } catch (err) { Swal.fire('Error', err.message, 'error'); }
    }

    function renderPreview() {
        const jsonStr = $('#json').val();
        if (!jsonStr.trim()) { $('#flex-show').html('<div class="text-white text-center mt-5 opacity-50"><i class="bi bi-chat-square-dots display-1"></i><p class="mt-2">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p></div>'); return; }
        try {
            let json = JSON.parse(jsonStr);
            if (json.type === "bubble" || json.type === "carousel") json = { type: "flex", altText: "Preview", contents: json };
            $('#flex-show').empty();
            if (typeof flex2html === 'function') flex2html('flex-show', json);
        } catch (e) { $('#flex-show').html('<div class="alert alert-danger mt-3">Invalid JSON</div>'); }
    }

    function isValidJson(str) { try { JSON.parse(str); return true; } catch (e) { return false; } }

    function resetEditorState() {
        currentFlexId = null;
        $('#save-btn').html('<i class="bi bi-save me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å').removeClass('btn-warning').addClass('btn-primary');
        $('#json').val(''); $('#altText').val(''); renderPreview();
    }
  </script>
</body>
</html>
