<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏£‡πå Flex Message</title>

  <!-- CSS Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  
  <!-- SweetAlert2 -->
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- jQuery (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô flexhtml.js) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Custom Library (‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) -->
  <script src="flexhtml.js"></script>
  <link rel="stylesheet" href="flexhtml.css">

  <style>
    :root {
      --primary-color: #06c755;
      --bg-color: #f8f9fa;
    }

    body {
      background-color: var(--bg-color);
      font-family: 'Kanit', sans-serif;
      overflow-x: hidden;
    }

    .hide {
      display: none !important;
    }

    /* Loader */
    #loader-sec {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: white;
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .spinner-custom {
      width: 3rem;
      height: 3rem;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Login Section */
    #login-sec {
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .btn-line {
      background-color: #06c755;
      color: white;
      font-weight: 600;
    }
    .btn-line:hover {
      background-color: #05b34c;
      color: white;
    }

    /* Main App */
    .preview-box {
      background-color: #849ebf;
      background-image: url('https://cdn.pixabay.com/photo/2016/06/02/02/33/triangles-1430105_1280.png'); 
      background-size: cover;
      min-height: 400px;
      max-height: 600px;
      overflow-y: auto;
      border-radius: 10px;
      padding: 15px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
    }
    
    /* Reset CSS for FlexHTML */
    .reset-this {
        all: initial;
        font-family: 'Kanit', sans-serif; 
    }
    .reset-this * {
        box-sizing: border-box;
    }

    .flex-card {
      transition: transform 0.2s;
      border-left: 5px solid var(--primary-color);
      position: relative;
    }
    
    .flex-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
    }

    /* --- FIX: Class ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏Å‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏õ‡∏¥‡∏î --- */
    .high-z-index {
      z-index: 1050 !important;
      position: relative;
      transform: none !important; 
    }

    .avatar-img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border: 2px solid var(--primary-color);
    }
    
    .code-toolbar {
        background: #f1f3f5;
        padding: 5px 10px;
        border-radius: 5px 5px 0 0;
        border: 1px solid #dee2e6;
        border-bottom: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Pagination Styles */
    .page-link {
        color: var(--primary-color);
        cursor: pointer;
    }
    .page-link:hover {
        color: #05b34c;
    }
    .page-item.active .page-link {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
    .page-item.disabled .page-link {
        color: #6c757d;
    }
  </style>
</head>

<body>

  <!-- Loading Screen -->
  <section id="loader-sec">
    <div class="spinner-custom mb-3"></div>
    <div class="fw-bold text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </section>

  <!-- Login Screen -->
  <section id="login-sec" class="hide">
    <div class="text-center p-5 bg-white rounded shadow-sm">
      <h3 class="fw-bold mb-4">Flex Message Creator</h3>
      <p class="text-muted mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
      <button class="btn btn-lg btn-line w-100" id="login-btn">
        <i class="bi bi-line me-2"></i> Log in with LINE
      </button>
    </div>
  </section>

  <!-- Main App -->
  <section id="input-sec" class="container py-4 hide">
    
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-4">
      <div>
        <h4 class="fw-bold mb-0">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="displayName" class="text-primary">User</span></h4>
        <small class="text-muted">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏£‡πå Flex Message ‡∏á‡πà‡∏≤‡∏¢‡πÜ</small>
      </div>
      <div class="d-flex gap-2">
         <button onclick="clearCache()" class="btn btn-sm btn-outline-secondary" title="‡∏•‡πâ‡∏≤‡∏á Cache Draft"><i class="bi bi-eraser"></i></button>
         <img id="display-img" class="rounded-circle avatar-img shadow-sm" src="" alt="Profile">
      </div>
    </div>

    <!-- Inputs -->
    <div class="row g-4">
      <div class="col-lg-7">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body">
            
            <div class="mb-3">
              <label for="altText" class="form-label fw-bold">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏ó (Alt Text)</label>
              <div class="input-group">
                <input type="text" class="form-control" id="altText" maxlength="400" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!">
                <span class="input-group-text bg-light" id="text-count">0/400</span>
              </div>
            </div>

            <div class="mb-2 d-flex justify-content-between align-items-center">
              <label for="json" class="form-label fw-bold mb-0">Flex JSON Code</label>
              <div class="dropdown">
                  <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-magic"></i> ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item template-select" href="#" data-type="welcome">üëã Welcome Message</a></li>
                    <li><a class="dropdown-item template-select" href="#" data-type="promotion">üè∑Ô∏è Promotion Card</a></li>
                    <li><a class="dropdown-item template-select" href="#" data-type="receipt">üßæ Receipt</a></li>
                  </ul>
                  <a href="https://developers.line.biz/flex-simulator/" target="_blank" class="btn btn-sm btn-outline-info ms-1">
                    <i class="bi bi-tools"></i> Sim
                  </a>
              </div>
            </div>
            
            <div class="code-toolbar">
                <small class="text-muted"><i class="bi bi-code-slash"></i> JSON Editor</small>
                <div>
                    <button class="btn btn-xs btn-light border btn-sm" id="format-btn" title="‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î"><i class="bi bi-text-indent-left"></i> Format</button>
                    <button class="btn btn-xs btn-light border btn-sm text-danger" id="clear-json-btn" title="‡∏•‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î"><i class="bi bi-trash"></i></button>
                </div>
            </div>
            <textarea id="json" class="form-control font-monospace mb-3 rounded-0 rounded-bottom" rows="12" style="font-size: 0.85rem; border-top: 0;" placeholder='‡∏ß‡∏≤‡∏á JSON code ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...'></textarea>

            <div class="row g-2">
              <div class="col-6">
                <button id="save-btn" class="btn btn-primary w-100">
                  <i class="bi bi-save me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
              </div>
              <div class="col-6">
                <button id="share-btn" class="btn btn-success w-100">
                  <i class="bi bi-share-fill me-1"></i> ‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏•‡∏¢
                </button>
              </div>
              <div class="col-12 mt-2">
                 <button id="send-chat-btn" class="btn btn-warning w-100 text-dark hide">
                  <i class="bi bi-send-fill me-1"></i> ‡∏™‡πà‡∏á‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏ô‡∏µ‡πâ
                </button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Preview -->
      <div class="col-lg-5">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-header bg-white fw-bold d-flex justify-content-between">
            <span><i class="bi bi-eye"></i> Live Preview</span>
            <small id="status-text" class="text-muted fw-normal" style="font-size: 0.8rem;"></small>
          </div>
          <div class="preview-box">
             <!-- Container for FlexHTML -->
             <div class="reset-this">
                <div id="flex-show" style="width: 100%; padding: 10px;">
                    <div class="text-white text-center mt-5 opacity-50">
                    <i class="bi bi-chat-square-dots display-1"></i>
                    <p class="mt-2">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                    </div>
                </div>
             </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Saved List -->
    <div class="mt-5">
      <!-- Search Bar -->
      <div class="d-flex justify-content-between align-items-center mb-3">
         <h5 class="fw-bold mb-0 border-start border-4 border-primary ps-2"> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h5>
         <div class="input-group input-group-sm" style="width: 200px;">
            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
            <input type="text" id="search-input" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠...">
         </div>
      </div>

      <div id="flexlist" class="row g-3">
        <!-- Template Item (Hidden) -->
        <div class="col-md-6 col-lg-4 template-item hide">
          <div class="card flex-card shadow-sm h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div class="text-truncate me-2 w-100 fw-bold item-name">Template Name</div>
              <div class="dropdown">
                <button class="btn btn-light btn-sm rounded-circle" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                  <li><a class="dropdown-item load-item" href="#"><i class="bi bi-pencil-square me-2 text-primary"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡πÇ‡∏´‡∏•‡∏î</a></li>
                  <li><a class="dropdown-item share-item" href="#"><i class="bi bi-share me-2 text-success"></i>‡πÅ‡∏ä‡∏£‡πå</a></li>
                  <li><a class="dropdown-item copy-link" href="#"><i class="bi bi-link-45deg me-2 text-warning"></i>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item delete-item text-danger" href="#"><i class="bi bi-trash me-2"></i>‡∏•‡∏ö</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <!-- End Template -->
      </div>
      
      <!-- Pagination Controls -->
      <nav aria-label="Page navigation" class="mt-4">
        <ul id="pagination-controls" class="pagination justify-content-center mb-0">
            <!-- JS will populate this -->
        </ul>
      </nav>

      <div id="empty-list" class="text-center text-muted py-5 hide">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      </div>
    </div>

  </section>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // --- Config ---
    const LIFF_ID = '2005615503-Ar8OBd2N'; // LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwDd1Nnw729Y01YuWrHVkgDU_8aKmWq15onm7sncp_IfU5SAwJmL3ccofV_UtQX5qMT/exec';

    // --- State ---
    let userProfile = null;
    let currentFlexId = null;
    let itemTemplate = null; // Store template
    let autoSaveTimer = null;
    
    // Pagination State
    let allItems = []; // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å API
    let filteredItems = []; // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    let currentPage = 1;
    const itemsPerPage = 6; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤

    // --- Utils ---
    const toast = Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 2000,
      timerProgressBar: true
    });
    
    // --- Template Data ---
    const SAMPLE_TEMPLATES = {
        welcome: {
          "type": "bubble",
          "hero": { "type": "image", "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_1_cafe.png", "size": "full", "aspectRatio": "20:13", "aspectMode": "cover" },
          "body": { "type": "box", "layout": "vertical", "contents": [ { "type": "text", "text": "Brown Cafe", "weight": "bold", "size": "xl" }, { "type": "text", "text": "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤!", "margin": "md" } ] }
        },
        promotion: {
          "type": "bubble",
          "body": { "type": "box", "layout": "vertical", "contents": [ { "type": "text", "text": "SALE 50%", "weight": "bold", "color": "#1DB446", "size": "sm" }, { "type": "text", "text": "‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡∏£‡∏∞‡∏´‡∏ô‡πà‡∏≥", "weight": "bold", "size": "xxl", "margin": "md" }, { "type": "text", "text": "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏£‡∏µ‡∏ö‡πÄ‡∏•‡∏¢!", "size": "xs", "color": "#aaaaaa", "wrap": true } ] },
          "footer": { "type": "box", "layout": "vertical", "contents": [ { "type": "button", "style": "primary", "color": "#905c44", "action": { "type": "uri", "label": "‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏•‡∏¢", "uri": "https://linecorp.com" } } ] }
        },
        receipt: {
            "type": "bubble",
            "body": { "type": "box", "layout": "vertical", "contents": [ { "type": "text", "text": "RECEIPT", "weight": "bold", "color": "#1DB446", "size": "sm" }, { "type": "text", "text": "Brown Store", "weight": "bold", "size": "xxl", "margin": "md" }, { "type": "separator", "margin": "xxl" }, { "type": "box", "layout": "vertical", "margin": "xxl", "spacing": "sm", "contents": [ { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "Energy Drink", "size": "sm", "color": "#555555", "flex": 0 }, { "type": "text", "text": "$2.99", "size": "sm", "color": "#111111", "align": "end" } ] } ] } ] }
        }
    };

    // --- Main Logic ---
    $(document).ready(function() {
        main();
        
        // Setup Template
        itemTemplate = $('.template-item').first().clone();
        
        // Event Listeners
        $('#json').on('input', function() { 
            renderPreview(); 
            handleAutoSave();
        });
        
        $('#altText').on('input', function() { 
            $('#text-count').text(`${this.value.length}/400`);
            handleAutoSave();
        });
        
        $('#login-btn').click(() => liff.login({ redirectUri: window.location.href }));
        $('#save-btn').click(saveFlex);
        
        $('#share-btn').click(() => {
            const jsonStr = $('#json').val();
            const altText = $('#altText').val();
            if(isValidJson(jsonStr)) {
                shareFlex(JSON.parse(jsonStr), altText);
            } else {
                Swal.fire('Error', 'JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            }
        });
        
        $('#send-chat-btn').click(sendInChat);
        
        // New Buttons
        $('#format-btn').click(formatJson);
        $('#clear-json-btn').click(() => {
            $('#json').val('');
            renderPreview();
            handleAutoSave();
        });
        
        $('.template-select').click(function(e) {
            e.preventDefault();
            const type = $(this).data('type');
            if(SAMPLE_TEMPLATES[type]) {
                const json = SAMPLE_TEMPLATES[type];
                $('#json').val(JSON.stringify(json, null, 2));
                renderPreview();
                handleAutoSave();
            }
        });

        // Search with Pagination Support
        $('#search-input').on('keyup', function() {
            const value = $(this).val().toLowerCase();
            // Filter from source data
            filteredItems = allItems.filter(item => 
                item.name.toLowerCase().includes(value)
            );
            // Reset to page 1 and render
            renderPage(1);
        });
    });

    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
        
        if (!liff.isLoggedIn()) {
          $('#loader-sec').addClass('hide');
          $('#login-sec').removeClass('hide');
          return;
        }

        const params = new URLSearchParams(window.location.search);
        const sharedId = params.get('s');

        if (sharedId) {
          await handleSharedLink(sharedId);
          return;
        }
        
        // Check Draft
        loadDraft();

        await loadUserProfile();
        $('#loader-sec').addClass('hide');
        $('#input-sec').removeClass('hide');
        
        fetchSavedList();

      } catch (err) {
        console.error(err);
        Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î LIFF: ' + err.message, 'error');
      }
    }
    
    // --- Pagination Logic ---
    function renderPage(page) {
        currentPage = page;
        
        // 1. Clear current list (except template)
        $('#flexlist').children().not('.template-item').remove();
        
        // 2. Check empty state
        if (filteredItems.length === 0) {
            $('#empty-list').removeClass('hide');
            $('#pagination-controls').empty();
            return;
        }
        $('#empty-list').addClass('hide');
        
        // 3. Calculate slice
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const itemsToShow = filteredItems.slice(start, end);
        
        // 4. Render items
        itemsToShow.forEach(item => renderListItem(item));
        
        // 5. Render Pagination Controls
        renderPaginationControls();
    }

    function renderPaginationControls() {
        const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
        const $pagination = $('#pagination-controls');
        $pagination.empty();

        if (totalPages <= 1) return; // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ä‡∏ß‡πå‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß

        // Prev Button
        const prevDisabled = currentPage === 1 ? 'disabled' : '';
        $pagination.append(`
            <li class="page-item ${prevDisabled}">
                <a class="page-link" onclick="renderPage(${currentPage - 1})">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</a>
            </li>
        `);

        // Page Numbers
        for (let i = 1; i <= totalPages; i++) {
            const active = i === currentPage ? 'active' : '';
            $pagination.append(`
                <li class="page-item ${active}">
                    <a class="page-link" onclick="renderPage(${i})">${i}</a>
                </li>
            `);
        }

        // Next Button
        const nextDisabled = currentPage === totalPages ? 'disabled' : '';
        $pagination.append(`
            <li class="page-item ${nextDisabled}">
                <a class="page-link" onclick="renderPage(${currentPage + 1})">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</a>
            </li>
        `);
    }

    // --- Auto Save Logic ---
    function handleAutoSave() {
        clearTimeout(autoSaveTimer);
        $('#status-text').text('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå...');
        autoSaveTimer = setTimeout(() => {
            const data = {
                json: $('#json').val(),
                altText: $('#altText').val(),
                date: new Date().getTime()
            };
            localStorage.setItem('flex_draft', JSON.stringify(data));
            $('#status-text').text('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πà‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß');
        }, 1000);
    }
    
    function loadDraft() {
        const draft = localStorage.getItem('flex_draft');
        if(draft) {
            try {
                const data = JSON.parse(draft);
                // Only load if fields are empty
                if(!$('#json').val()) $('#json').val(data.json || '');
                if(!$('#altText').val()) $('#altText').val(data.altText || '');
                renderPreview();
            } catch(e) {}
        }
    }
    
    function clearCache() {
        localStorage.removeItem('flex_draft');
        toast.fire('info', '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Draft ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        setTimeout(() => location.reload(), 500);
    }
    
    function formatJson() {
        const val = $('#json').val();
        if(!val) return;
        try {
            const obj = JSON.parse(val);
            $('#json').val(JSON.stringify(obj, null, 2));
        } catch(e) {
            toast.fire('error', 'JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
        }
    }

    async function loadUserProfile() {
      const context = liff.getContext();
      if (context && context.type === 'square_chat') {
        userProfile = { 
            displayName: 'OpenChat Member', 
            userId: context.squareMemberId, 
            pictureUrl: 'https://cdn-icons-png.flaticon.com/512/847/847969.png',
            isSquare: true 
        };
        $('#send-chat-btn').removeClass('hide');
      } else {
        userProfile = await liff.getProfile();
        if(liff.isInClient()) $('#send-chat-btn').removeClass('hide');
      }

      $('#displayName').text(userProfile.displayName);
      $('#display-img').attr('src', userProfile.pictureUrl || 'https://cdn-icons-png.flaticon.com/512/847/847969.png');
    }

    // --- API Interactions ---
    function callApi(action, data = {}) {
        const formData = {
            q: action,
            uid: userProfile.userId,
            isSquare: userProfile.isSquare || false,
            ...data
        };
        return $.post(SCRIPT_URL, formData);
    }

    function fetchSavedList() {
      callApi('get').done(function(res) {
          if (res.status === 200 && res.data.length > 0) {
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ state
            allItems = res.data;
            filteredItems = [...allItems]; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
            renderPage(1);
          } else {
            $('#flexlist').children().not('.template-item').remove();
            $('#empty-list').removeClass('hide');
            allItems = [];
            filteredItems = [];
          }
      }).fail(function() {
          Swal.fire('Error', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      });
    }

    function renderListItem(item) {
        if (!itemTemplate) return;
        
        let $clone = itemTemplate.clone();
        $clone.removeClass('hide template-item');
        
        $clone.find('.item-name').text(item.name);
        
        // --- FIX Z-INDEX ISSUE ---
        $clone.find('.dropdown').on('show.bs.dropdown', function () {
            $(this).closest('.col-md-6, .col-lg-4').addClass('high-z-index');
        }).on('hide.bs.dropdown', function () {
            $(this).closest('.col-md-6, .col-lg-4').removeClass('high-z-index');
        });

        // Bind Events
        $clone.find('.load-item').click(() => loadFlexToEditor(item));
        $clone.find('.share-item').click(() => shareFlex(JSON.parse(item.flex), item.name));
        $clone.find('.delete-item').click(function() { deleteFlex(item.flex_id, $clone); });
        $clone.find('.copy-link').click(() => {
            const link = `https://liff.line.me/${LIFF_ID}?s=${item.flex_id}`;
            navigator.clipboard.writeText(link).then(() => toast.fire('success', '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß'));
        });

        $('#flexlist').append($clone);
    }

    function handleSharedLink(id) {
        $.post(SCRIPT_URL, { q: 'getflex', id: id }).done(function(res) {
            if (res.status === 200 && res.flex) {
                $('#loader-sec').addClass('hide');
                $('#json').val(JSON.stringify(JSON.parse(res.flex), null, 4));
                $('#altText').val(res.altText || 'Flex Message');
                renderPreview();
                
                Swal.fire({
                    title: '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ä‡∏£‡πå',
                    text: `‡πÇ‡∏´‡∏•‡∏î Flex: ${res.altText} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`,
                    icon: 'success',
                    confirmButtonText: '‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏•‡∏¢'
                }).then((result) => {
                    if(result.isConfirmed) {
                          shareFlex(JSON.parse(res.flex), res.altText);
                    } else {
                          $('#input-sec').removeClass('hide');
                          loadUserProfile();
                    }
                });
            } else {
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Flex ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error').then(() => liff.closeWindow());
            }
        });
    }

    // --- Actions ---

    function loadFlexToEditor(item) {
        currentFlexId = item.flex_id;
        $('#altText').val(item.name);
        $('#json').val(JSON.stringify(JSON.parse(item.flex), null, 4));
        renderPreview();
        handleAutoSave();
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        $('#save-btn').html('<i class="bi bi-pencil-square me-1"></i> ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó');
        $('#save-btn').removeClass('btn-primary').addClass('btn-warning');
    }

    function saveFlex() {
        const jsonStr = $('#json').val();
        const altText = $('#altText').val() || 'Flex Message';

        if (!isValidJson(jsonStr)) return Swal.fire('Error', 'JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');

        if (currentFlexId) {
             Swal.showLoading();
             callApi('update', { id: currentFlexId, flex: jsonStr, name: altText }).done(function(res) {
                 Swal.close();
                 if(res.status === 200) {
                     toast.fire('success', '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                     fetchSavedList();
                     resetEditorState();
                 } else {
                     Swal.fire('Error', res.error, 'error');
                 }
             });
        } else {
            Swal.fire({
                title: '‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ Flex',
                input: 'text',
                inputValue: altText,
                showCancelButton: true,
                preConfirm: (name) => {
                    if (!name) Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠!');
                    return name;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.showLoading();
                    callApi('put', { 
                        name: result.value, 
                        flex: jsonStr, 
                        liff_id: liff.id 
                    }).done(function(res) {
                        Swal.close();
                        if (res.result === 'success') {
                            toast.fire('success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                            fetchSavedList();
                        } else if (res.result === 'duplicate') {
                            Swal.fire('Warning', '‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô', 'warning');
                        } else {
                            Swal.fire('Error', res.message, 'error');
                        }
                    });
                }
            });
        }
    }

    function deleteFlex(id, $domElement) {
        Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.showLoading();
                callApi('delete', { id: id }).done(function(res) {
                    Swal.close();
                    if (res.result === 200) {
                        $domElement.remove();
                        toast.fire('success', '‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                        if(currentFlexId === id) resetEditorState();
                        
                        // Update arrays and pagination after deletion
                        allItems = allItems.filter(item => item.flex_id !== id);
                        filteredItems = filteredItems.filter(item => item.flex_id !== id);
                        renderPage(currentPage); // Re-render current page
                        
                    } else {
                        Swal.fire('Error', '‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                    }
                });
            }
        });
    }

    async function shareFlex(flexContent, altText) {
        const message = {
            type: 'flex',
            altText: altText || 'Sent a Flex Message',
            contents: flexContent
        };

        if (!liff.isApiAvailable('shareTargetPicker')) {
            Swal.fire('Error', '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå (ShareTargetPicker)', 'error');
            return;
        }

        try {
            const res = await liff.shareTargetPicker([message]);
            if (res) {
                Swal.fire('Success', '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            }
        } catch (err) {
            console.error(err);
        }
    }
    
    async function sendInChat() {
        const jsonStr = $('#json').val();
        const altText = $('#altText').val() || 'Flex Message';
        
        if (!isValidJson(jsonStr)) return Swal.fire('Error', 'JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        
        const message = {
            type: 'flex',
            altText: altText,
            contents: JSON.parse(jsonStr)
        };
        
        try {
            await liff.sendMessages([message]);
            Swal.fire('Success', '‡∏™‡πà‡∏á‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success').then(() => liff.closeWindow());
        } catch (err) {
            Swal.fire('Error', '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + err.message, 'error');
        }
    }

    // --- Helpers ---
    function renderPreview() {
        const jsonStr = $('#json').val();
        const $display = $('#flex-show');
        
        if (!jsonStr.trim()) {
            $display.html('<div class="text-white text-center mt-5 opacity-50"><i class="bi bi-chat-square-dots display-1"></i><p class="mt-2">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p></div>');
            return;
        }

        try {
            const json = JSON.parse(jsonStr);
            $display.empty();
            
            if (typeof flex2html === 'function') {
                // flex2html usually takes ID string, not element
                flex2html('flex-show', json);
            } else {
                $display.html('<div class="alert alert-warning">Library flexhtml.js ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î</div>');
            }
        } catch (e) {
            $display.html('<div class="alert alert-danger mt-3">Invalid JSON</div>');
        }
    }

    function isValidJson(str) {
        try {
            JSON.parse(str);
            return true;
        } catch (e) { return false; }
    }

    function resetEditorState() {
        currentFlexId = null;
        $('#save-btn').html('<i class="bi bi-save me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        $('#save-btn').removeClass('btn-warning').addClass('btn-primary');
        $('#json').val('');
        $('#altText').val('');
        // Clear draft when successfully saved/reset
        localStorage.removeItem('flex_draft');
        renderPreview();
    }
  </script>
</body>
</html>
