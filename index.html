<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ระบบบันทึกและแชร์ Flex Message</title>
  
  <!-- CSS Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

  <link rel="stylesheet" href="flexhtml.css">
  <!-- Favicon -->
  <link rel="icon" href="https://th.bing.com/th/id/OIG4.QbUR8N98pPSmXzzUykuK?dpr=3&pid=ImgDetMain" type="image/x-icon">
  
  <style>
    :root {
      --primary-color: #00B900;
      --secondary-color: #06C755;
      --dark-color: #1E1E1E;
      --light-color: #F8F9FA;
      --gray-color: #6C757D;
    }
    
    body {
      background-color: var(--light-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--dark-color);
    }
    
    .line-theme {
      background-color: var(--primary-color);
      color: white;
    }
    
    .line-theme:hover {
      background-color: var(--secondary-color);
      color: white;
    }
    
    .card-shadow {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card-shadow:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }
    
    .flex-preview {
      background-color: #849ebf;
      background-image: url('https://example.com/line-bg.jpg');
      background-size: cover;
      border-radius: 12px;
      min-height: 400px;
      overflow: auto;
    }
    
    .template-card {
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .template-card:hover {
      background-color: #f1f1f1;
    }
    
    .loader-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .spinner {
      width: 3rem;
      height: 3rem;
    }
    
    .json-editor {
      font-family: 'Courier New', Courier, monospace;
      font-size: 14px;
      min-height: 400px;
    }
    
    .nav-tabs .nav-link.active {
      font-weight: bold;
      border-bottom: 3px solid var(--primary-color);
    }
    
    @media (max-width: 768px) {
      .flex-container {
        flex-direction: column-reverse;
      }
    }
  </style>
</head>

<body>
  <!-- Loading Screen -->
  <div id="loader" class="loader-container">
    <div class="text-center">
      <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">กำลังโหลดระบบ...</p>
    </div>
  </div>

  <!-- Login Section -->
  <section id="login-sec" class="d-none vh-100 d-flex justify-content-center align-items-center">
    <div class="card card-shadow animate__animated animate__fadeIn" style="width: 320px;">
      <div class="card-body text-center p-4">
        <img src="https://img.icons8.com/fluency-systems-regular/96/00B900/line-me.png" width="64" alt="LINE Logo">
        <h4 class="card-title mt-3">ระบบบันทึก Flex Message</h4>
        <p class="card-text text-muted">กรุณาล็อกอินด้วย LINE เพื่อเริ่มใช้งาน</p>
        <button id="login-btn" class="btn line-theme btn-lg w-100 mt-3">
          <i class="bi bi-line"></i> ล็อกอินด้วย LINE
        </button>
      </div>
    </div>
  </section>

  <!-- Main App Section -->
  <section id="app-sec" class="d-none">
    <!-- Header -->
    <header class="bg-white shadow-sm py-3">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <img id="profile-img" src="" class="rounded-circle me-3" width="40" height="40" alt="Profile">
            <h4 class="m-0">สวัสดี, <span id="displayName"></span></h4>
          </div>
          <button id="logout-btn" class="btn btn-outline-danger btn-sm">
            <i class="bi bi-box-arrow-right"></i> ออกจากระบบ
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container my-4">
      <div class="row g-4 flex-container">
        <!-- Left Column - Editor -->
        <div class="col-lg-7">
          <div class="card card-shadow h-100">
            <div class="card-header bg-white">
              <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                  <a class="nav-link active" data-bs-toggle="tab" href="#editor-tab">Editor</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" data-bs-toggle="tab" href="#guide-tab">คู่มือการใช้งาน</a>
                </li>
              </ul>
            </div>
            
            <div class="card-body tab-content">
              <!-- Editor Tab -->
              <div class="tab-pane fade show active" id="editor-tab">
                <div class="mb-3">
                  <label for="altText" class="form-label">ข้อความแสดงแทน (Alt Text)</label>
                  <input type="text" class="form-control" id="altText" maxlength="400" placeholder="ข้อความที่จะแสดงเมื่อไม่สามารถแสดง Flex Message ได้">
                  <div class="form-text text-end"><span id="text-count">0</span>/400 ตัวอักษร</div>
                </div>
                
                <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <label for="json" class="form-label mb-0">Flex Message JSON</label>
                    <a href="https://developers.line.biz/flex-simulator/" target="_blank" class="btn btn-sm btn-outline-info">
                      <i class="bi bi-window-plus"></i> ออกแบบ Flex
                    </a>
                  </div>
                  <textarea id="json" class="form-control json-editor" rows="15" placeholder="วางโค้ด JSON ของ Flex Message ที่นี่..."></textarea>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                  <button id="preview-btn" class="btn btn-outline-primary">
                    <i class="bi bi-eye"></i> ดูตัวอย่าง
                  </button>
                  <button id="save-btn" class="btn btn-primary">
                    <i class="bi bi-save"></i> บันทึก
                  </button>
                  <button id="share-btn" class="btn btn-success">
                    <i class="bi bi-share"></i> แชร์
                  </button>
                </div>
              </div>
              
              <!-- Guide Tab -->
              <div class="tab-pane fade" id="guide-tab">
                <h5><i class="bi bi-info-circle"></i> คู่มือการใช้งาน</h5>
                <ol class="mt-3">
                  <li class="mb-2">ไปที่ <a href="https://developers.line.biz/flex-simulator/" target="_blank">LINE Flex Simulator</a> เพื่อออกแบบ Flex Message</li>
                  <li class="mb-2">คัดลอกโค้ด JSON จาก Flex Simulator มาใส่ในช่อง Editor</li>
                  <li class="mb-2">ตั้งชื่อและบันทึก Template ไว้ใช้งานในภายหลัง</li>
                  <li class="mb-2">กดปุ่มแชร์เพื่อส่งไปยังห้องแชทหรือเพื่อน</li>
                </ol>
                
                <div class="alert alert-info mt-4">
                  <h6><i class="bi bi-lightbulb"></i> เคล็ดลับ</h6>
                  <ul class="mb-0">
                    <li>สามารถกดปุ่ม "ดูตัวอย่าง" เพื่อตรวจสอบ Flex Message ก่อนแชร์</li>
                    <li>Template ที่บันทึกไว้จะแสดงในส่วน "Template ของฉัน"</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Right Column - Preview -->
        <div class="col-lg-5">
          <div class="card card-shadow h-100">
            <div class="card-header bg-white">
              <h5 class="m-0"><i class="bi bi-phone"></i> ตัวอย่าง Flex Message</h5>
            </div>
            <div class="card-body p-0">
              <div id="flex-preview" class="flex-preview d-flex justify-content-center align-items-center">
                <div class="text-center text-white p-4">
                  <i class="bi bi-layout-text-sidebar" style="font-size: 3rem;"></i>
                  <p class="mt-3 mb-0">พื้นที่แสดงตัวอย่าง Flex Message<br>จะปรากฏที่นี่</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Saved Templates Section -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card card-shadow">
            <div class="card-header bg-white">
              <h5 class="m-0"><i class="bi bi-collection"></i> Template ของฉัน</h5>
            </div>
            <div class="card-body">
              <div id="templates-container" class="row g-3">
                <!-- Templates will be loaded here -->
                <div class="col-12 text-center py-5" id="no-templates">
                  <i class="bi bi-folder-x" style="font-size: 3rem; color: #adb5bd;"></i>
                  <p class="mt-3 text-muted">ยังไม่มี Template ที่บันทึกไว้</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </section>

  <!-- Preview Modal -->
  <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-eye"></i> ตัวอย่าง Flex Message</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <div id="modal-preview" class="flex-preview" style="min-height: 60vh;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> ปิด
          </button>
          <button type="button" class="btn btn-primary" id="copy-json-btn">
            <i class="bi bi-clipboard"></i> คัดลอก JSON
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Template Actions Modal -->
  <div class="modal fade" id="templateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="templateModalTitle">จัดการ Template</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-outline-primary template-action-btn" data-action="preview">
              <i class="bi bi-eye"></i> ดูตัวอย่าง
            </button>
            <button type="button" class="btn btn-outline-success template-action-btn" data-action="share">
              <i class="bi bi-share"></i> แชร์ไปห้องแชทอื่น
            </button>
            <button type="button" class="btn btn-outline-info template-action-btn" data-action="edit">
              <i class="bi bi-pencil"></i> แก้ไข JSON
            </button>
            <button type="button" class="btn btn-outline-secondary template-action-btn" data-action="copy-link">
              <i class="bi bi-link-45deg"></i> คัดลอกลิงก์แชร์
            </button>
            <button type="button" class="btn btn-outline-danger template-action-btn" data-action="delete">
              <i class="bi bi-trash"></i> ลบ Template
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="flexhtml.js"></script>
  
  <script>
    // Global variables
    let profile = null;
    let currentTemplateId = null;
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbyjB3lt2Gi6hLFZS4cvW6gcGA5qpYMZsQC3rJuysoBlPb9sXseV9YXWbwWF6oA67yV0/exec';
    
    // Initialize the app
    $(document).ready(() => {
      initializeApp();
    });
    
    // Main initialization function
    async function initializeApp() {
      // Initialize LIFF
      await initializeLiff();
      
      // Set up event listeners
      setupEventListeners();
      
      // Load templates if logged in
      if (profile) {
        loadTemplates();
      }
    }
    
    // Initialize LIFF
    async function initializeLiff() {
      try {
        await liff.init({ liffId: '2005615503-Ar8OBd2N' });
        
        if (liff.isLoggedIn()) {
          // Get profile
          const context = await liff.getContext();
          profile = context.type === 'square_chat' 
            ? { displayName: 'Open Chat', userId: context.squareMemberId, isSquare: true }
            : await liff.getProfile();
          
          // Update UI
          updateUserProfile();
          $('#loader').fadeOut();
          $('#app-sec').removeClass('d-none');
          
          // Check for shared flex
          checkSharedFlex();
        } else {
          $('#loader').fadeOut();
          $('#login-sec').removeClass('d-none').addClass('d-flex');
        }
      } catch (error) {
        console.error('LIFF initialization failed', error);
        showError('เกิดข้อผิดพลาดในการเชื่อมต่อ LINE');
      }
    }
    
    // Set up event listeners
    function setupEventListeners() {
      // Login button
      $('#login-btn').click(() => liff.login());
      
      // Logout button
      $('#logout-btn').click(logout);
      
      // Alt text counter
      $('#altText').on('input', updateTextCounter);
      
      // JSON editor change
      $('#json').on('input', updateFlexPreview);
      
      // Buttons
      $('#preview-btn').click(showPreviewModal);
      $('#save-btn').click(saveTemplate);
      $('#share-btn').click(shareFlex);
      $('#copy-json-btn').click(copyJsonToClipboard);
      
      // Template actions
      $(document).on('click', '.template-card', function() {
        currentTemplateId = $(this).data('id');
        $('#templateModal').modal('show');
      });
      
      $('.template-action-btn').click(function() {
        const action = $(this).data('action');
        handleTemplateAction(action);
      });
    }
    
    // Update user profile in UI
    function updateUserProfile() {
      $('#displayName').text(profile.displayName);
      $('#profile-img').attr('src', profile.pictureUrl || 'https://via.placeholder.com/40');
    }
    
    // Update character counter
    function updateTextCounter() {
      const count = $('#altText').val().length;
      $('#text-count').text(count);
    }
    
    // Update flex preview
    function updateFlexPreview() {
      const json = getFlexJson(true);
      const $preview = $('#flex-preview');
      
      if (!json) {
        $preview.html(`
          <div class="text-center text-white p-4">
            <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
            <p class="mt-3 mb-0">รูปแบบ JSON ไม่ถูกต้อง</p>
          </div>
        `);
        return;
      }
      
      $preview.empty();
      flex2html('flex-preview', json);
    }
    
    // Get flex JSON
    function getFlexJson(noError = false) {
      try {
        const jsonText = $('#json').val();
        if (!jsonText.trim()) return null;
        
        const json = JSON.parse(jsonText);
        
        // Create full flex message if needed
        if (json.type !== 'flex') {
          return {
            type: 'flex',
            altText: $('#altText').val() || 'Flex Message',
            contents: json
          };
        }
        
        return json;
      } catch (error) {
        if (!noError) {
          Swal.fire({
            icon: 'error',
            title: 'JSON ไม่ถูกต้อง',
            text: 'กรุณาตรวจสอบรูปแบบ JSON อีกครั้ง'
          });
        }
        return null;
      }
    }
    
    // Show preview modal
    function showPreviewModal() {
      const flex = getFlexJson();
      if (!flex) return;
      
      $('#modal-preview').empty();
      flex2html('modal-preview', flex);
      $('#previewModal').modal('show');
    }
    
    // Save template
    function saveTemplate() {
      const flex = getFlexJson();
      if (!flex) return;
      
      Swal.fire({
        title: 'บันทึก Template',
        input: 'text',
        inputLabel: 'ชื่อ Template',
        inputPlaceholder: 'ใส่ชื่อที่ต้องการบันทึก',
        showCancelButton: true,
        confirmButtonText: 'บันทึก',
        cancelButtonText: 'ยกเลิก',
        inputValidator: (value) => {
          if (!value) {
            return 'กรุณาใส่ชื่อ Template';
          }
        }
      }).then((result) => {
        if (result.isConfirmed) {
          saveTemplateToServer(result.value, flex);
        }
      });
    }
    
    // Save template to server
    function saveTemplateToServer(name, flex) {
      $.ajax({
        url: scriptUrl,
        method: 'POST',
        data: {
          q: 'put',
          name: name,
          flex: JSON.stringify(flex),
          altText: $('#altText').val(),
          uid: profile.userId,
          isSquare: profile.isSquare,
          liff_id: liff.id
        },
        success: (response) => {
          if (response.result === 'duplicate') {
            Swal.fire('ชื่อซ้ำ', 'มี Template ชื่อนี้อยู่แล้ว กรุณาใช้ชื่ออื่น', 'warning');
            return;
          }
          
          Swal.fire('สำเร็จ', 'บันทึก Template เรียบร้อยแล้ว', 'success');
          loadTemplates();
        },
        error: () => {
          Swal.fire('ผิดพลาด', 'ไม่สามารถบันทึก Template ได้', 'error');
        }
      });
    }
    
    // Share flex message
    async function shareFlex() {
      const flex = getFlexJson();
      if (!flex) return;
      
      try {
        const result = await liff.shareTargetPicker([flex]);
        if (!result) {
          console.log('Share canceled');
        }
      } catch (error) {
        console.error('Share failed:', error);
        Swal.fire('ผิดพลาด', 'ไม่สามารถแชร์ข้อความได้', 'error');
      }
    }
    
    // Load templates
    function loadTemplates() {
      $.ajax({
        url: scriptUrl,
        method: 'POST',
        data: {
          q: 'get',
          uid: profile.userId,
          isSquare: profile.isSquare
        },
        beforeSend: () => {
          $('#templates-container').LoadingOverlay('show');
        },
        success: (response) => {
          displayTemplates(response.data || []);
        },
        error: () => {
          Swal.fire('ผิดพลาด', 'ไม่สามารถโหลด Template ได้', 'error');
        },
        complete: () => {
          $('#templates-container').LoadingOverlay('hide');
        }
      });
    }
    
    // Display templates
    function displayTemplates(templates) {
      const $container = $('#templates-container');
      
      if (templates.length === 0) {
        $('#no-templates').show();
        return;
      }
      
      $('#no-templates').hide();
      $container.empty();
      
      templates.forEach(template => {
        const date = new Date(template.createdAt).toLocaleDateString('th-TH');
        
        $container.append(`
          <div class="col-md-6 col-lg-4">
            <div class="card template-card card-shadow" data-id="${template.flex_id}">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                  <h6 class="card-title mb-1">${template.name}</h6>
                  <span class="badge bg-light text-dark">${date}</span>
                </div>
                <p class="card-text text-muted small mb-2">${template.altText || 'ไม่มีข้อความแสดงแทน'}</p>
                <div class="d-flex justify-content-end">
                  <button class="btn btn-sm btn-outline-secondary me-2 quick-use-btn" data-id="${template.flex_id}">
                    <i class="bi bi-lightning"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots-vertical"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><button class="dropdown-item template-action" data-action="preview"><i class="bi bi-eye"></i> ดูตัวอย่าง</button></li>
                    <li><button class="dropdown-item template-action" data-action="share"><i class="bi bi-share"></i> แชร์</button></li>
                    <li><button class="dropdown-item template-action" data-action="edit"><i class="bi bi-pencil"></i> แก้ไข</button></li>
                    <li><button class="dropdown-item template-action" data-action="copy-link"><i class="bi bi-link-45deg"></i> คัดลอกลิงก์</button></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><button class="dropdown-item text-danger template-action" data-action="delete"><i class="bi bi-trash"></i> ลบ</button></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        `);
      });
    }
    
    // Handle template actions
    function handleTemplateAction(action) {
      const template = getTemplateById(currentTemplateId);
      if (!template) return;
      
      switch (action) {
        case 'preview':
          previewTemplate(template);
          break;
        case 'share':
          shareTemplate(template);
          break;
        case 'edit':
          editTemplate(template);
          break;
        case 'copy-link':
          copyTemplateLink(template);
          break;
        case 'delete':
          deleteTemplate(template);
          break;
      }
      
      $('#templateModal').modal('hide');
    }
    
    // Get template by ID
    function getTemplateById(id) {
      // In a real app, you would fetch this from the server or maintain in memory
      // For simplicity, we'll assume it's available
      return null;
    }
    
    // Logout
    function logout() {
      liff.logout();
      window.location.reload();
    }
    
    // Show error message
    function showError(message) {
      Swal.fire('ผิดพลาด', message, 'error');
    }
    
    // Check for shared flex
    function checkSharedFlex() {
      const urlParams = new URLSearchParams(window.location.search);
      const flexId = urlParams.get('s');
      
      if (flexId) {
        loadSharedFlex(flexId);
      }
    }
    
    // Load shared flex
    function loadSharedFlex(flexId) {
      $.ajax({
        url: scriptUrl,
        method: 'POST',
        data: {
          q: 'getflex',
          id: flexId
        },
        beforeSend: () => {
          $('#loader').show();
        },
        success: (response) => {
          if (response.flex) {
            $('#json').val(JSON.stringify(JSON.parse(response.flex), null, 2));
            $('#altText').val(response.altText);
            updateFlexPreview();
            $('#share-btn').click();
          } else {
            showError('ไม่พบ Flex ที่ต้องการแชร์');
          }
        },
        error: () => {
          showError('ไม่สามารถโหลด Flex ที่แชร์ได้');
        },
        complete: () => {
          $('#loader').hide();
        }
      });
    }
    
    // Copy JSON to clipboard
    function copyJsonToClipboard() {
      navigator.clipboard.writeText($('#json').val()).then(() => {
        Swal.fire({
          icon: 'success',
          title: 'คัดลอกแล้ว',
          showConfirmButton: false,
          timer: 1500
        });
      });
    }
  </script>
</body>
</html>
